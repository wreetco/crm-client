<!doctype html>
<div class="" id="contact-info-card" style="padding-left: 1.5em;">
  <div class="row">
    <div class="col s12">
      <h3 ng-if="current_contact._id">
        {{ current_contact.x.first_name }} {{ current_contact.x.last_name }}
      </h3>
      <h3 ng-if="!(current_contact._id)">
        Post Contact
      </h3>
      <div class="row" ng-if="current_contact._id">
        <div class="col s2">
          <i class="material-icons left">phone</i>Phone:
        </div>
        <div class="col s10">
          {{ current_contact.x.phone_num }}
        </div>
      </div>
      <div class="row" ng-if="current_contact._id">
        <div class="col s2">
          <i class="material-icons left">email</i>Email:
        </div>
        <div class="col s10">
          {{ current_contact.x.email_address }}
        </div>
      </div>
      <div class="row" ng-if="current_contact._id">
        <div class="col s2">
          <i class="material-icons left">account_balance</i>Organization:
        </div>
        <div class="col s10">
          {{ current_contact.x.organization }}
        </div>
      </div>
      <div class="row" ng-if="current_contact._id">
        <div class="col s2">
          <i class="material-icons">date_range</i>Created:
        </div>
        <div class="col s10">
          {{ current_contact.created_date | date:'medium'}}
        </div>
      </div>
      <div class="row" ng-if="current_contact._id">
        <div class="col s2">
          <i class="material-icons">date_range</i>Modified:
        </div>
        <div class="col s10">
          {{ current_contact.updated_at | date:'medium' }}
        </div>
      </div>


      <div class="row">
        <div ng-repeat="section in current_fields | orderBy:'-name' : true" ng-show="!section.fields.length < 1">
          <h3 ng-hide="$first">
            {{ section.name }}
          </h3>
          <div class="row">
            <div ng-repeat="field in section.fields | orderBy:'-order' : true " ng-hide="field.master">
              <div class="col s12 m6 input-field">
                <input id="{{ field.db_name }}" type="text" crm-type="{{ field.type }}" class="field-selector" ng-model="current_contact.x[field.db_name]" readonly onclick="editable(this);" onblur="noneditable(this);">
                <label for="{{ field.db_name }}" class="light">
                  {{ field.name }}
                </label>
                <a id="{{ field.db_name }}-icon" style="visibility: hidden; margin: .3em; cursor: pointer;" class="right" ng-click="fieldModal();">
                  <i class="material-icons right" >settings</i>
                </a>
              </div>
            </div>
          </div>
          <div class="row" style="display: none">
            <h6>
              New Field
            </h6>
            <div class="col s6 m3">
              <input name="" id="new-field-label-{{ section.name }}" type="text" />
              <label for="new-field-input-{{ section.name }}">Field Label</label>
            </div>
            <div class="col s6 m3">
              <input name="" id="new-field-value-{{ section.name }}" type="text" />
              <label for="new-field-input-{{ section.name }}">Field Value</label>
            </div>
            <div class="col s6 m3">
              <a class="btn" ng-click="addField(section.name, current_contact);"><i class="material-icons left">add_box</i>Add Field</a>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col s12 m6">
          <h4>
            Tags
          </h4>
          <div id="chip-section">
            <input placeholder="+Tag" type="text" id="new-tag" />
          </div>
        </div>
      </div>

      <div class="row" style="margin-bottom:0;">
        <div class="col s12 m12">
          <button class="btn-large" style="width: 100%;" ng-if="current_contact._id" ng-click="updateRecord(current_contact);">Save Changes</button>
        </div>
        <div class="col s12 m12">
          <button class="btn-large" style="width: 100%;" ng-if="!(current_contact._id)" ng-click="postRecord(current_contact);">Post Contact</button>
        </div>
        <div class="col s12 m12">
          <button class="btn-large" style="width: 100%;" ng-click="">Add New Section</button>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  function editable(el){
    el.removeAttribute("readonly");
    var icon_id = el.id + "-icon";
    var icon = document.getElementById(icon_id);
    if(icon){
      icon.style.opacity = 1;
      icon.style.visibility = "visible";
      icon.style.WebkitTransition = "visibility linear .5s";
      icon.style.WebkitTransition = "opacity linear .5s";
    }
  };

  function noneditable(el){
    el.setAttribute("readonly", "");
    var icon_id = el.id + "-icon";
    var icon = document.getElementById(icon_id);
    //prevent it from disapearing for 150ms or else the button cant be clicked

    if(icon){
      setTimeout(function(){
        icon.style.visibility = "hidden";
        icon.style.opacity = 0;
        icon.style.WebkitTransition = "visibility linear .4s";
        icon.style.WebkitTransition = "opacity linear .4s";
      }, 200);
    }
  };

  $( "#new-tag" ).keypress(function(e) {
    if(e.keyCode === 13 || e.keyCode === 44){
      var tag_name = $('#new-tag').val();
      var tag_id = 'tag-id-' + tag_name;
      tag_id = tag_id.replace(/\s+/g, '-');
      if(!(document.getElementById(tag_id))){
        $("<div class=\"chip\" id=\"" + tag_id + "\">" + tag_name + " <i class=\"close material-icons\" onclick=\"closeTag(" + tag_id + ")\">close</i>").insertBefore('#new-tag');
      }
      setTimeout(function(){
        $('#new-tag').val('');
      }, 99);
    }
  });

  function closeTag(tid){
    document.getElementById(tid).parentNode.removeChild(document.getElementById(tid));
  };

</script>
